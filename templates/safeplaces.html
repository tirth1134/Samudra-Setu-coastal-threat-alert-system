{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Samudra Setu Gujarat — Stay Safe on the Shore</title>
  <meta name="description" content="Find nearest shelters, hospitals and police stations on Gujarat's coast. Search, filter and suggest new safe places." />

  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ocean: {
              50: '#f0f8ff',
              100: '#e0f2ff',
              200: '#bae6fd',
              300: '#7dd3fc',
              400: '#38bdf8',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              800: '#075985',
              900: '#0c4a6e',
            }
          },
          boxShadow: {
            glow: '0 0 0 2px rgba(255,255,255,0.06), 0 10px 30px rgba(2,132,199,0.35)'
          },
          backgroundImage: {
            'ocean-grad': 'radial-gradient(1200px 600px at 10% 0%, rgba(56,189,248,0.25), transparent 50%), radial-gradient(900px 500px at 90% -10%, rgba(14,165,233,0.25), transparent 55%), linear-gradient(180deg, #031A2B 0%, #061E30 30%, #07263C 100%)',
            'grid': 'linear-gradient(to right, rgba(255,255,255,0.06) 1px, transparent 1px), linear-gradient(to bottom, rgba(255,255,255,0.06) 1px, transparent 1px)'
          }
        }
      }
    };
  </script>

  <style>
    /* Page-specific small tweaks */
    #map { height: 58vh; min-height: 420px; border-radius: 1rem; }
    .list-item { transition: background .18s ease, transform .12s ease; }
    .list-item:hover { background: rgba(255,255,255,0.02); transform: translateX(4px); }
    .chip { display:inline-flex; align-items:center; gap:0.5rem; padding:.25rem .6rem; border-radius:999px; font-weight:600; font-size:.825rem }
    /* Subtle animated shine for buttons */
    .btn-shine { position: relative; overflow: hidden; }
    .btn-shine::after {
      content: ""; position: absolute; inset: -150% -50% auto auto; width: 40%; height: 300%;
      background: linear-gradient(120deg, rgba(255,255,255,0.0) 0%, rgba(255,255,255,0.35) 40%, rgba(255,255,255,0.0) 80%);
      transform: rotate(25deg); opacity: 0; transition: opacity .3s ease; pointer-events: none;
    }
    .btn-shine:hover::after { opacity: 1; animation: sweep 1s ease forwards; }
    @keyframes sweep { to { transform: translateX(-220%) rotate(25deg); } }

    /* Fancy underline on nav links */
    .link-fancy { position: relative; }
    .link-fancy::after {
      content: ""; position: absolute; left: 0; bottom: -6px; height: 2px; width: 100%;
      background: linear-gradient(90deg, #38bdf8, #0ea5e9, #0369a1);
      transform: scaleX(0); transform-origin: left; transition: transform .3s ease;
    }
    .link-fancy:hover::after { transform: scaleX(1); }

    /* Card hover lift */
    .card { transition: transform .35s ease, box-shadow .35s ease, border-color .35s ease; }
    .card:hover { transform: translateY(-6px); box-shadow: 0 20px 40px rgba(2,132,199,.25); }

    /* Background grid overlay */
    .grid-overlay { background-size: 40px 40px, 40px 40px; mask-image: radial-gradient(circle at center, black 60%, transparent 100%); opacity:.25; }
  </style>
</head>
<body class="min-h-screen text-slate-100 bg-ocean-grad relative">
  <!-- Decorative background grid -->
  <div class="grid-overlay bg-grid absolute inset-0 pointer-events-none"></div>

  <!-- Navbar -->
  <header class="relative z-40">
    <nav class="mx-auto max-w-7xl px-4 py-5 flex items-center justify-between">
      <a href="{% url 'index' %}" class="flex items-center gap-3 group">
        <img src="{% static 'images/White.png' %}"
            alt="SamudraSetu Logo" 
            class="w-auto h-20 object-contain">
      </a>
      <button id="menuBtn" class="md:hidden inline-flex items-center justify-center rounded-xl border border-white/10 px-3 py-2 hover:bg-white/5">
        <span class="sr-only">Open menu</span>
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
      </button>

      <ul id="menu" class="hidden md:flex items-center gap-8 text-sm">
        <li><a class="link-fancy hover:text-white/90" href="{% url 'alerts' %}">Alerts</a></li>
        <li><a class="link-fancy hover:text-white/90" href="{% url 'safeplaces' %}">Safe Places</a></li>
        <li><a class="link-fancy hover:text-white/90" href="{% url 'fisheries' %}">Fisheries</a></li>
        <li><a class="link-fancy hover:text-white/90" href="{% url 'pollution' %}">Report Pollution</a></li>
      </ul>

      <div class="hidden md:flex items-center gap-3">
        <a href="#subscribe" class="btn-shine inline-flex items-center gap-2 rounded-xl bg-white/10 hover:bg-white/15 px-4 py-2 border border-white/15 shadow-glow transition">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M2.25 6.75A2.25 2.25 0 0 1 4.5 4.5h15a2.25 2.25 0 0 1 2.25 2.25v10.5A2.25 2.25 0 0 1 19.5 19.5h-15A2.25 2.25 0 0 1 2.25 17.25V6.75Zm1.5 0 8.25 5.25L20.25 6.75m-16.5 9.75 4.87-3.105M20.25 16.5l-4.87-3.105"/></svg>
          <span class="font-semibold">Get SMS Alerts</span>
        </a>
      </div>
    </nav>
    <!-- Mobile menu -->
    <div id="mobileMenu" class="md:hidden hidden mx-4 mb-4 rounded-2xl border border-white/10 bg-white/5 backdrop-blur p-4">
      <ul class="space-y-3">
        <li><a class="block link-fancy py-2" href="{% url 'alerts' %}">Alerts</a></li>
        <li><a class="block link-fancy py-2" href="{% url 'safeplaces' %}">Safe Places</a></li>
        <li><a class="block link-fancy py-2" href="{% url 'fisheries' %}">Fisheries</a></li>
        <li><a class="block link-fancy py-2" href="{% url 'pollution' %}">Report Pollution</a></li>
      </ul>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-10">
    <div class="grid lg:grid-cols-3 gap-8">
      <!-- Left: Controls & list -->
      <section class="lg:col-span-1">
        <div class="rounded-2xl p-5 bg-slate-900/40 border border-white/6">
          <h2 class="text-lg font-bold">Find Safe Places</h2>
          <p class="text-slate-400 text-sm mt-1">Search mapped shelters, hospitals and police stations along the Gujarat coast.</p>

          <div class="mt-4">
            <label class="text-xs text-slate-400">Search</label>
            <input id="searchInput" type="search" placeholder="Search by name or town" class="w-full mt-2 rounded-xl px-3 py-2 bg-slate-800 border border-white/6 focus:outline-none focus:ring-2 focus:ring-ocean-400" />
          </div>

          <div class="mt-4 flex gap-2 flex-wrap">
            <button data-filter="all" class="filterBtn chip bg-white/5 border border-white/6">All</button>
            <button data-filter="shelter" class="filterBtn chip bg-white/5 border border-white/6">Shelters</button>
            <button data-filter="hospital" class="filterBtn chip bg-white/5 border border-white/6">Hospitals</button>
            <button data-filter="police" class="filterBtn chip bg-white/5 border border-white/6">Police</button>
          </div>

          <div class="mt-4">
            <h3 class="text-sm font-semibold">Nearby</h3>
            <div id="placesList" class="mt-3 space-y-3 max-h-[56vh] overflow-auto pr-2">
              <!-- dynamic list -->
            </div>
          </div>
        </div>

        <!-- Suggest form (sends to /api/safe-places or stores locally) -->
        <div id="suggest" class="mt-6 rounded-2xl p-5 bg-slate-900/30 border border-white/6">
          <h3 class="font-semibold">Suggest a new safe place</h3>
          <p class="text-slate-400 text-sm mt-1">Submit location details and we'll review it (admin verification required).</p>
          <form id="suggestForm" class="mt-3 space-y-3" onsubmit="return submitSuggest(event)">
            <input id="s_name" class="w-full rounded-xl px-3 py-2 bg-slate-800 border border-white/6" placeholder="Name (e.g. Veraval Relief Center)" required />
            <input id="s_type" list="types" class="w-full rounded-xl px-3 py-2 bg-slate-800 border border-white/6" placeholder="Type (shelter/hospital/police)" required />
            <datalist id="types"><option>shelter</option><option>hospital</option><option>police</option></datalist>
            <input id="s_location" class="w-full rounded-xl px-3 py-2 bg-slate-800 border border-white/6" placeholder="Town / Location" />
            <div class="flex gap-2">
              <input id="s_lat" class="flex-1 rounded-xl px-3 py-2 bg-slate-800 border border-white/6" placeholder="Latitude" />
            </div>
            <div class="flex gap-2">
              <input id="s_lon" class="flex-1 rounded-xl px-3 py-2 bg-slate-800 border border-white/6" placeholder="Longitude" />
            </div>
            <div class="flex gap-2">
              <button type="submit" class="rounded-xl px-4 py-2 bg-ocean-600 font-semibold">Submit</button>
              <button type="button" onclick="useMyLocation()" class="rounded-xl px-4 py-2 border border-white/6">Use My Location</button>
            </div>
            <p id="suggestStatus" class="text-xs text-slate-400"></p>
          </form>
        </div>
      </section>

      <!-- Middle & Right: Map & Details -->
      <section class="lg:col-span-2">
        <div class="rounded-2xl p-4 bg-slate-900/40 border border-white/6">
          <div class="flex items-center justify-between gap-4 mb-4">
            <div>
              <h3 class="text-lg font-bold">Map</h3>
              <p class="text-slate-400 text-sm">Click a marker or list item to view details and open directions.</p>
            </div>
            <div class="flex items-center gap-3">
              <button id="locateBtn" class="rounded-xl px-3 py-2 border border-white/6">Find Me</button>
              <button id="clusterToggle" class="rounded-xl px-3 py-2 border border-white/6">Toggle Clusters</button>
            </div>
          </div>

          <div id="map"></div>

          <div id="detailsCard" class="mt-4 rounded-xl p-4 bg-slate-900/30 border border-white/6 hidden">
            <!-- populated on marker click -->
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer class="max-w-7xl mx-auto px-4 pb-10 text-center text-xs text-slate-500">© 2025 Setu Safety Gujarat — Safe Place Finder</footer>

  <script>
    // ---------- Sample safe places data (replace with backend /api/safe-places) ----------
    const SAFE_PLACES = [
      { id:1, name:'Porbandar Relief Centre', type:'shelter', town:'Porbandar', lat:21.6420, lon:69.6286, phone:'+919812345678' },
      { id:2, name:'Okha Community Hospital', type:'hospital', town:'Okha', lat:22.4680, lon:69.0470, phone:'+919876543210' },
      { id:3, name:'Dwarka Police Station', type:'police', town:'Dwarka', lat:22.2420, lon:68.9685, phone:'+919901234567' },
      { id:4, name:'Veraval Evac Shelter', type:'shelter', town:'Veraval', lat:20.8990, lon:70.3595, phone:'+919812111222' },
      { id:5, name:'Gopnath Clinic', type:'hospital', town:'Gopnath', lat:21.4640, lon:72.2030, phone:'+919812333444' },
      { id:6, name:'Porbandar Coast Guard', type:'police', town:'Porbandar', lat:21.6445, lon:69.6320, phone:'+919812777888' }
    ];

    // ---------- Map setup ----------
    const map = L.map('map', { preferCanvas: true }).setView([21.6, 69.6], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(map);

    // marker cluster group
    let markersGroup = L.markerClusterGroup();
    let markers = [];
    let useClusters = true;

    // custom colored circle markers per type
    function makeIcon(color){
      return L.divIcon({
        className: 'custom-div-icon',
        html: `<svg width="34" height="34" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C8 2 5 6 5 9.5c0 5 7 11.5 7 11.5s7-6.5 7-11.5C19 6 16 2 12 2z" fill="${color}" stroke="#fff" stroke-width="1.2"/></svg>`,
        iconSize: [34,34],
        iconAnchor: [17,34]
      });
    }

    const ICONS = { shelter: makeIcon('#06b6d4'), hospital: makeIcon('#60a5fa'), police: makeIcon('#f97316') };

    function addMarkers(list){
      markersGroup.clearLayers(); markers = [];
      list.forEach(p => {
        const marker = L.marker([p.lat, p.lon], { icon: ICONS[p.type] || ICONS.shelter });
        marker.bindPopup(`<strong>${p.name}</strong><br/><small>${p.type.toUpperCase()} • ${p.town}</small><br/><a href='https://www.google.com/maps/search/?api=1&query=${p.lat},${p.lon}' target='_blank' class='text-xs'>Open directions</a>`);
        marker.on('click', ()=> showDetails(p));
        markers.push({ marker, data: p });
        markersGroup.addLayer(marker);
      });
      if(useClusters) map.addLayer(markersGroup); else markers.forEach(m=>m.marker.addTo(map));
    }

    function showDetails(place){
      const card = document.getElementById('detailsCard');
      card.classList.remove('hidden');
      card.innerHTML = `
        <div class='flex items-start justify-between'>
          <div>
            <h4 class='font-bold text-lg'>${place.name}</h4>
            <p class='text-slate-400 text-sm'>${place.type.toUpperCase()} • ${place.town}</p>
            <p class='text-slate-400 text-sm mt-2'>Phone: <a href='tel:${place.phone}' class='text-ocean-200'>${place.phone}</a></p>
          </div>
          <div class='text-right'>
            <a class='rounded-xl px-3 py-2 bg-ocean-600 text-sm inline-block' href='https://www.google.com/maps/dir/?api=1&destination=${place.lat},${place.lon}' target='_blank'>Directions</a>
          </div>
        </div>
      `;
      // centre map
      map.setView([place.lat, place.lon], 13, { animate: true });
    }

    // initialise list and markers
    function renderList(list){
      const container = document.getElementById('placesList');
      container.innerHTML = '';
      list.forEach(p=>{
        const el = document.createElement('div');
        el.className = 'list-item p-3 rounded-lg border border-white/6 flex items-start justify-between';
        el.innerHTML = `<div><p class='font-semibold'>${p.name}</p><p class='text-xs text-slate-400'>${p.town} • ${p.type}</p></div><div class='text-right'><button class='px-3 py-1 rounded-md border border-white/6 text-xs' onclick='focusPlace(${p.id})'>Open</button></div>`;
        container.appendChild(el);
      });
    }

    function focusPlace(id){
      const p = SAFE_PLACES.find(x=>x.id===id);
      if(!p) return;
      showDetails(p);
      // open popup
      const m = markers.find(m=>m.data.id===id);
      if(m) m.marker.openPopup();
    }

    // filter logic
    function filterPlaces(q, type){
      let filtered = SAFE_PLACES.slice();
      if(type && type!=='all') filtered = filtered.filter(p=>p.type===type);
      if(q) filtered = filtered.filter(p=> (p.name + ' ' + p.town).toLowerCase().includes(q.toLowerCase()));
      renderList(filtered);
      // update markers
      // remove all layers then add just filtered markers
      markersGroup.clearLayers();
      if(!useClusters) { markers.forEach(m=>map.removeLayer(m.marker)); }
      filtered.forEach(p=>{
        const mobj = markers.find(mm=>mm.data.id===p.id);
        if(mobj) {
          if(useClusters) markersGroup.addLayer(mobj.marker); else mobj.marker.addTo(map);
        }
      });
      if(useClusters) { if(!map.hasLayer(markersGroup)) map.addLayer(markersGroup); }
    }

    // attach controls
    document.getElementById('searchInput').addEventListener('input', (e)=> filterPlaces(e.target.value, currentFilter));
    const filterBtns = document.querySelectorAll('.filterBtn');
    let currentFilter = 'all';
    filterBtns.forEach(btn=> btn.addEventListener('click', (e)=>{ currentFilter = btn.dataset.filter; document.querySelectorAll('.filterBtn').forEach(b=>b.classList.remove('bg-ocean-600','text-black')); btn.classList.add('bg-ocean-600','text-black'); filterPlaces(document.getElementById('searchInput').value, currentFilter); }));

    document.getElementById('locateBtn').addEventListener('click', ()=> useMyLocation());
    document.getElementById('clusterToggle').addEventListener('click', ()=>{ useClusters = !useClusters; addMarkers(SAFE_PLACES); document.getElementById('clusterToggle').innerText = useClusters? 'Disable Clusters' : 'Enable Clusters'; });

    // initial build
    addMarkers(SAFE_PLACES);
    renderList(SAFE_PLACES);

    // center to bounds
    const group = L.featureGroup(markers.map(m=>m.marker));
    if(group.getLayers().length) map.fitBounds(group.getBounds().pad(0.15));

    // use geolocation
    function useMyLocation(){
      if(!navigator.geolocation) return alert('Geolocation not supported');
      navigator.geolocation.getCurrentPosition(pos=>{
        const {latitude, longitude} = pos.coords;
        map.setView([latitude, longitude], 12);
        // optionally show nearest place
        const nearest = SAFE_PLACES.map(p=>({p, d: distanceKm(latitude, longitude, p.lat, p.lon)})).sort((a,b)=>a.d-b.d)[0];
        if(nearest && nearest.d < 50) { // show if reasonably close
          showDetails(nearest.p);
          const m = markers.find(m=>m.data.id===nearest.p.id); if(m) m.marker.openPopup();
        }
      }, err=> alert('Unable to fetch location: ' + err.message));
    }

    // Haversine distance
    function distanceKm(lat1,lon1,lat2,lon2){
      const R = 6371; const dLat = toRad(lat2-lat1); const dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R * c;
      function toRad(v){ return v * Math.PI/180; }
    }

    // Suggest submit handler (posts to /api/safe-places or stores locally for demo)
    async function submitSuggest(e){
      e.preventDefault();
      const name = document.getElementById('s_name').value.trim();
      const type = document.getElementById('s_type').value.trim().toLowerCase();
      const town = document.getElementById('s_location').value.trim();
      const lat = parseFloat(document.getElementById('s_lat').value);
      const lon = parseFloat(document.getElementById('s_lon').value);
      const status = document.getElementById('suggestStatus');
      if(!name || !type || isNaN(lat) || isNaN(lon)) { status.innerText = 'Please provide name, type, and valid coordinates.'; return false; }

      const payload = { name, type, town, lat, lon };
      status.innerText = 'Submitting...';

      try{
        // Try POST to backend if available
        const r = await fetch('/api/safe-places', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        if(r.ok){ status.innerText = 'Submitted — admin will verify.'; document.getElementById('suggestForm').reset(); }
        else { throw new Error('Backend responded ' + r.status); }
      } catch (err){
        // Backend not present — fallback: add locally for demo
        const newId = SAFE_PLACES.length + 1; SAFE_PLACES.push({ id:newId, ...payload, phone: '' });
        addMarkers(SAFE_PLACES); renderList(SAFE_PLACES); status.innerText = 'Added locally for demo. (No backend)'; document.getElementById('suggestForm').reset();
      }
      return false;
    }

  </script>
</body>
</html>
