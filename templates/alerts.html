{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Samudra Setu Gujarat — Stay Safe on the Shore</title>
  <meta name="description" content="Real-time flood alerts, safe place finder, fishery advisories, and pollution reporting for Gujarat's coastline." />
  
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ocean: {
              50: '#f0f8ff',
              100: '#e0f2ff',
              200: '#bae6fd',
              300: '#7dd3fc',
              400: '#38bdf8',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              800: '#075985',
              900: '#0c4a6e',
            }
          },
          boxShadow: {
            glow: '0 0 0 2px rgba(255,255,255,0.06), 0 10px 30px rgba(2,132,199,0.35)'
          },
          backgroundImage: {
            'ocean-grad': 'radial-gradient(1200px 600px at 10% 0%, rgba(56,189,248,0.25), transparent 50%), radial-gradient(900px 500px at 90% -10%, rgba(14,165,233,0.25), transparent 55%), linear-gradient(180deg, #031A2B 0%, #061E30 30%, #07263C 100%)',
            'grid': 'linear-gradient(to right, rgba(255,255,255,0.06) 1px, transparent 1px), linear-gradient(to bottom, rgba(255,255,255,0.06) 1px, transparent 1px)'
          }
        }
      }
    };
  </script>
  
  <style>
    .card { transition: transform .28s ease, box-shadow .28s ease; }
    .card:hover { transform: translateY(-6px); box-shadow: 0 18px 36px rgba(2,132,199,0.18); }
    .pill { display:inline-flex; align-items:center; gap:.5rem; padding:.25rem .6rem; border-radius:999px; font-weight:600; font-size:.85rem }
    .severity-low { background: rgba(6,95,70,0.12); color:#34d399; border:1px solid rgba(52,211,153,0.12) }
    .severity-medium { background: rgba(245,158,11,0.08); color:#f59e0b; border:1px solid rgba(245,158,11,0.12) }
    .severity-high { background: rgba(239,68,68,0.08); color:#ef4444; border:1px solid rgba(239,68,68,0.12) }
    .severity-critical { background: rgba(139,92,246,0.06); color:#7c3aed; border:1px solid rgba(124,58,237,0.12) }
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Page-specific small tweaks */
    #map { height: 58vh; min-height: 420px; border-radius: 1rem; }
    .list-item { transition: background .18s ease, transform .12s ease; }
    .list-item:hover { background: rgba(255,255,255,0.02); transform: translateX(4px); }
    .chip { display:inline-flex; align-items:center; gap:0.5rem; padding:.25rem .6rem; border-radius:999px; font-weight:600; font-size:.825rem }
    /* Subtle animated shine for buttons */
    .btn-shine { position: relative; overflow: hidden; }
    .btn-shine::after {
      content: ""; position: absolute; inset: -150% -50% auto auto; width: 40%; height: 300%;
      background: linear-gradient(120deg, rgba(255,255,255,0.0) 0%, rgba(255,255,255,0.35) 40%, rgba(255,255,255,0.0) 80%);
      transform: rotate(25deg); opacity: 0; transition: opacity .3s ease; pointer-events: none;
    }
    .btn-shine:hover::after { opacity: 1; animation: sweep 1s ease forwards; }
    @keyframes sweep { to { transform: translateX(-220%) rotate(25deg); } }

    /* Fancy underline on nav links */
    .link-fancy { position: relative; }
    .link-fancy::after {
      content: ""; position: absolute; left: 0; bottom: -6px; height: 2px; width: 100%;
      background: linear-gradient(90deg, #38bdf8, #0ea5e9, #0369a1);
      transform: scaleX(0); transform-origin: left; transition: transform .3s ease;
    }
    .link-fancy:hover::after { transform: scaleX(1); }

    /* Card hover lift */
    .card { transition: transform .35s ease, box-shadow .35s ease, border-color .35s ease; }
    .card:hover { transform: translateY(-6px); box-shadow: 0 20px 40px rgba(2,132,199,.25); }

    /* Background grid overlay */
    .grid-overlay { background-size: 40px 40px, 40px 40px; mask-image: radial-gradient(circle at center, black 60%, transparent 100%); opacity:.25; }
  </style>
</head>
<body class="min-h-screen text-slate-100 bg-ocean-grad relative">
  <!-- Decorative background grid -->
  <div class="grid-overlay bg-grid absolute inset-0 pointer-events-none"></div>

  <!-- Navbar -->
  <header class="relative z-40">
    <nav class="mx-auto max-w-7xl px-4 py-5 flex items-center justify-between">
      <a href="{% url 'index' %}" class="flex items-center gap-3 group">
        <img src="{% static 'images/White.png' %}"
            alt="SamudraSetu Logo" 
            class="w-auto h-20 object-contain">
      </a>
      <button id="menuBtn" class="md:hidden inline-flex items-center justify-center rounded-xl border border-white/10 px-3 py-2 hover:bg-white/5">
        <span class="sr-only">Open menu</span>
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
      </button>

      <ul id="menu" class="hidden md:flex items-center gap-8 text-sm">
        <li><a class="link-fancy hover:text-white/90" href="{% url 'alerts' %}">Alerts</a></li>
        <li><a class="link-fancy hover:text-white/90" href="{% url 'safeplaces' %}">Safe Places</a></li>
        <li><a class="link-fancy hover:text-white/90" href="{% url 'fisheries' %}">Fisheries</a></li>
        <li><a class="link-fancy hover:text-white/90" href="{% url 'pollution' %}">Report Pollution</a></li>
      </ul>

      <div class="hidden md:flex items-center gap-3">
        <a href="#subscribe" class="btn-shine inline-flex items-center gap-2 rounded-xl bg-white/10 hover:bg-white/15 px-4 py-2 border border-white/15 shadow-glow transition">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M2.25 6.75A2.25 2.25 0 0 1 4.5 4.5h15a2.25 2.25 0 0 1 2.25 2.25v10.5A2.25 2.25 0 0 1 19.5 19.5h-15A2.25 2.25 0 0 1 2.25 17.25V6.75Zm1.5 0 8.25 5.25L20.25 6.75m-16.5 9.75 4.87-3.105M20.25 16.5l-4.87-3.105"/></svg>
          <span class="font-semibold">Get SMS Alerts</span>
        </a>
      </div>
    </nav>
    <!-- Mobile menu -->
    <div id="mobileMenu" class="md:hidden hidden mx-4 mb-4 rounded-2xl border border-white/10 bg-white/5 backdrop-blur p-4">
      <ul class="space-y-3">
        <li><a class="block link-fancy py-2" href="{% url 'alerts' %}">Alerts</a></li>
        <li><a class="block link-fancy py-2" href="{% url 'safeplaces' %}">Safe Places</a></li>
        <li><a class="block link-fancy py-2" href="{% url 'fisheries' %}">Fisheries</a></li>
        <li><a class="block link-fancy py-2" href="{% url 'pollution' %}">Report Pollution</a></li>
      </ul>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-10 grid lg:grid-cols-3 gap-8">

    <!-- Tide Information -->
    <div class="mt-6 card rounded-2xl p-6 bg-slate-900/40 border border-white/6">
      <h2 class="text-xl font-bold">Live Tide Information</h2>
      <p class="text-slate-400 text-sm mt-1">Powered by Stormglass API</p>
    
      <div id="tideSummary" class="mt-4 space-y-2">
        <p>Next High Tide: <span id="nextHigh">—</span></p>
        <p>Next Low Tide: <span id="nextLow">—</span></p>
      </div>
      <br><br>
      <!-- Wave Graph -->
      <canvas id="waveGraph" class="mt-4"></canvas>
    
      <!-- Tide Chart -->
      <canvas id="tideChart" class="mt-4"></canvas>
    </div>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // Example wave graph (sine-like wave data)
      const ctxWave = document.getElementById("waveGraph").getContext("2d");
      new Chart(ctxWave, {
        type: "line",
        data: {
          labels: Array.from({length: 50}, (_, i) => i),
          datasets: [{
            label: "Wave Height (m)",
            data: Array.from({length: 50}, (_, i) => Math.sin(i/3) + 1.5), // sine wave mock data
            borderColor: "#3b82f6",
            backgroundColor: "rgba(59,130,246,0.2)",
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: { display: false },
            y: { beginAtZero: true }
          }
        }
      });
    </script>
    
    <!-- Left column: Controls & summary -->
    <section class="lg:col-span-1">
      <div class="card rounded-2xl p-6 bg-slate-900/40 border border-white/6">
        <h2 class="text-xl font-bold">Live Alerts</h2>
        <p class="text-slate-400 mt-2 text-sm">Real-time setu alerts from your backend system. Auto-refreshes every 30 seconds.</p>

        <div class="mt-4 space-y-3">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-xs text-slate-400">Auto-refresh</p>
              <p class="text-sm font-medium">Every <span id="intervalLabel">30</span> secs</p>
            </div>
            <div class="flex items-center gap-2">
              <input id="autoRefresh" type="checkbox" checked class="w-5 h-5" />
              <button id="settingsBtn" class="px-3 py-1 rounded-md border border-white/6 text-sm">Settings</button>
            </div>
          </div>

          <div class="pt-3 border-t border-white/6"></div>

          <div>
            <p class="text-xs text-slate-400">Alert Statistics</p>
            <div class="mt-2 space-y-2">
              <div class="flex items-center justify-between p-2 rounded-md bg-slate-800/30">
                <span class="text-sm">Total Alerts</span>
                <span id="totalAlerts" class="font-semibold text-ocean-400">-</span>
              </div>
              <div class="flex items-center justify-between p-2 rounded-md bg-slate-800/30">
                <span class="text-sm">Active Alerts</span>
                <span id="activeAlerts" class="font-semibold text-green-400">-</span>
              </div>
              <div class="flex items-center justify-between p-2 rounded-md bg-slate-800/30">
                <span class="text-sm">SMS Subscribers</span>
                <span id="smsSubscribers" class="font-semibold text-blue-400">-</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Severity legend -->
      <div class="mt-6 card rounded-2xl p-4 bg-slate-900/30 border border-white/6">
        <h3 class="font-semibold">Severity Levels</h3>
        <div class="mt-3 flex flex-col gap-2 text-sm">
          <div class="flex items-center gap-3"><span class="pill severity-low">Low</span> <span class="text-slate-400">Normal conditions.</span></div>
          <div class="flex items-center gap-3"><span class="pill severity-medium">Medium</span> <span class="text-slate-400">Potential concern — monitor.</span></div>
          <div class="flex items-center gap-3"><span class="pill severity-high">High</span> <span class="text-slate-400">High risk — prepare.</span></div>
          <div class="flex items-center gap-3"><span class="pill severity-critical">Critical</span> <span class="text-slate-400">Severe — evacuate if told.</span></div>
        </div>
      </div>

    </section>
  </main>
  <!-- Subscribe / Twilio CTA (placeholder) -->
  <section id="subscribe" class="mx-auto max-w-7xl px-4 pb-16">
    <div class="rounded-3xl border border-white/10 bg-gradient-to-r from-white/5 to-white/10 p-6 md:p-8 card">
      <div class="md:flex items-center justify-between gap-6">
        <div class="max-w-2xl">
          <h3 class="text-xl font-bold">Get instant SMS alerts</h3>
          <p class="text-slate-300 text-sm mt-1">Subscribe with your phone number to receive automated flood warnings (powered by Twilio).</p>
        </div>
        <form id="smsForm" class="mt-4 md:mt-0 flex w-full md:w-auto gap-3">
          <input type="tel" id="phoneNumber" placeholder="Enter mobile number" 
                 class="flex-1 md:w-80 rounded-xl px-4 py-3 bg-slate-900/60 border border-white/10 focus:outline-none focus:ring-2 focus:ring-ocean-400" 
                 required />
          <button type="submit" class="btn-shine rounded-xl px-5 py-3 font-semibold bg-gradient-to-br from-ocean-400 to-ocean-600 shadow-glow">Subscribe</button>
        </form>
      </div>
      
      <!-- Status message -->
      <div id="smsStatus" class="mt-4 hidden">
        <div id="smsSuccess" class="hidden p-3 rounded-xl bg-green-500/20 border border-green-400/30 text-green-200 text-sm"></div>
        <div id="smsError" class="hidden p-3 rounded-xl bg-red-500/20 border border-red-400/30 text-red-200 text-sm"></div>
      </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="border-t border-white/10 bg-slate-950/60 backdrop-blur">
    <div class="mx-auto max-w-7xl px-4 py-10 grid md:grid-cols-3 gap-8 text-sm">
      <div>
        <p class="font-extrabold text-lg">Samudra Setu</p>
        <p class="text-slate-400 mt-2">Hackathon Prototype · Gujarat, India</p>
      </div>
      <div>
        <p class="font-bold mb-2">Quick Links</p>
        <ul class="space-y-1 text-slate-300">
          <li><a class="hover:underline" href="{% url 'alerts' %}">Alerts</a></li>
          <li><a class="hover:underline" href="{% url 'safeplaces' %}">Safe Places</a></li>
          <li><a class="hover:underline" href="{% url 'fisheries' %}">Fisheries</a></li>
          <li><a class="hover:underline" href="{% url 'pollution' %}">Report Pollution</a></li>
          <li><a class="hover:underline" href="{% url 'adminfrontend' %}">Admin</a></li>
        </ul>
      </div>
      <div>
        <p class="font-bold mb-2">Contact</p>
        <p class="text-slate-300">samudra-setu@hackathon.dev</p>
      </div>
    </div>
    <div class="text-center text-xs text-slate-500 pb-8">©️ 2025 SamudraSetu Safety Gujarat</div>
  </footer>

  <script>
    /* ---------- CONFIG ---------- */
    let autoRefreshInterval = 30 * 1000; // 30 seconds default
    let autoRefreshId = null;

    document.getElementById('intervalLabel').innerText = Math.round(autoRefreshInterval / 1000);

    /* ---------- UTIL ---------- */
    function severityClass(severity) {
      return {
        'low': 'severity-low',
        'medium': 'severity-medium',
        'high': 'severity-high',
        'critical': 'severity-critical'
      }[severity] || 'severity-medium';
    }

    function formatTime(ts) { 
      const date = new Date(ts);
      return date.toLocaleString('en-IN', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function getTimeAgo(createdAt) {
      const now = new Date();
      const created = new Date(createdAt);
      const diffMs = now - created;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffDays > 0) return ${diffDays} day${diffDays !== 1 ? 's' : ''} ago;
      if (diffHours > 0) return ${diffHours} hour${diffHours !== 1 ? 's' : ''} ago;
      if (diffMins > 0) return ${diffMins} minute${diffMins !== 1 ? 's' : ''} ago;
      return 'Just now';
    }

    /* ---------- FETCHERS ---------- */
    async function fetchAlerts() {
      try {
        const response = await fetch('/api/alerts/');
        if (!response.ok) throw new Error('Failed to fetch alerts');
        const data = await response.json();
        return data.alerts || [];
      } catch (error) {
        console.error('Error fetching alerts:', error);
        return [];
      }
    }

    async function fetchSubscribers() {
      try {
        const response = await fetch('/api/subscribers/');
        if (!response.ok) throw new Error('Failed to fetch subscribers');
        const data = await response.json();
        return data.subscribers || [];
      } catch (error) {
        console.error('Error fetching subscribers:', error);
        return [];
      }
    }

    async function createAlert(title, description, severity) {
      try {
        const response = await fetch('/api/create-alert/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ title, description, severity })
        });
        
        if (!response.ok) throw new Error('Failed to create alert');
        const data = await response.json();
        return data;
      } catch (error) {
        console.error('Error creating alert:', error);
        throw error;
      }
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    /* ---------- UI RENDER ---------- */
    function renderAlertsGrid(alerts) {
      const grid = document.getElementById('alertsGrid');
      const noAlertsMessage = document.getElementById('noAlertsMessage');
      
      if (alerts.length === 0) {
        grid.innerHTML = '';
        noAlertsMessage.classList.remove('hidden');
        return;
      }

      noAlertsMessage.classList.add('hidden');
      grid.innerHTML = '';
      
      alerts.forEach(alert => {
        const card = document.createElement('div');
        card.className = 'rounded-2xl p-4 bg-slate-900/30 border border-white/6 card fade-in';
        
        const severityClass = severityClass(alert.severity);
        const severityLabel = alert.severity.toUpperCase();
        const timeAgo = getTimeAgo(alert.created_at);
        
        card.innerHTML = `
          <div class='flex items-start justify-between'>
            <div class='flex-1'>
              <h4 class='font-semibold text-lg'>${alert.title}</h4>
              <p class='text-sm text-slate-400 mt-1'>${alert.description}</p>
              <p class='text-xs text-slate-500 mt-2'>Created: ${timeAgo}</p>
            </div>
            <div class='text-right ml-4'>
              <div class='pill ${severityClass}'>${severityLabel}</div>
              <p class='text-xs text-slate-400 mt-2'>ID: ${alert.id}</p>
            </div>
          </div>
          <div class='mt-3 flex gap-2'>
            <button class='px-3 py-1 rounded-md border border-white/6 text-sm' onclick='viewAlertDetails(${alert.id})'>Details</button>
            <button class='px-3 py-1 rounded-md bg-ocean-600 text-sm' onclick='sendSMSAlert(${alert.id})'>Send SMS</button>
          </div>
        `;
        
        grid.appendChild(card);
      });
    }

    function updateStatistics(alerts, subscribers) {
      document.getElementById('totalAlerts').textContent = alerts.length;
      document.getElementById('activeAlerts').textContent = alerts.filter(a => a.is_active).length;
      document.getElementById('smsSubscribers').textContent = subscribers.filter(s => s.is_active).length;
    }

    function viewAlertDetails(alertId) {
      // Find the alert in the current data
      const alert = currentAlerts.find(a => a.id === alertId);
      if (!alert) return alert('Alert not found');
      
      const content = JSON.stringify(alert, null, 2);
      const pre = document.getElementById('rawJson');
      pre.textContent = content;
      pre.classList.remove('hidden');
      window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'});
    }

    async function sendSMSAlert(alertId) {
      try {
        // This would trigger SMS sending to all subscribers
        alert('SMS notifications sent to all subscribers for this alert!');
      } catch (error) {
        alert('Failed to send SMS: ' + error.message);
      }
    }

    /* ---------- BOOTSTRAP ---------- */
    let currentAlerts = [];
    let currentSubscribers = [];

    async function refreshAll() {
      document.getElementById('lastUpdated').innerText = 'Updating...';
      
      try {
        const [alerts, subscribers] = await Promise.all([
          fetchAlerts(),
          fetchSubscribers()
        ]);
        
        currentAlerts = alerts;
        currentSubscribers = subscribers;
        
        renderAlertsGrid(alerts);
        updateStatistics(alerts, subscribers);
        document.getElementById('lastUpdated').innerText = formatTime(Date.now());
        
        // Update raw JSON
        const pre = document.getElementById('rawJson');
        pre.textContent = JSON.stringify({ alerts, subscribers }, null, 2);
        
      } catch (error) {
        console.error('Refresh error:', error);
        document.getElementById('lastUpdated').innerText = 'Error updating';
      }
    }

    // Event Listeners
    document.getElementById('refreshBtn').addEventListener('click', refreshAll);

    // Auto-refresh control
    const autoCheckbox = document.getElementById('autoRefresh');
    const autoStateLabel = document.getElementById('autoState');
    
    function startAuto() {
      if (autoRefreshId) clearInterval(autoRefreshId);
      autoRefreshId = setInterval(refreshAll, autoRefreshInterval);
      autoStateLabel.innerText = 'On';
    }
    
    function stopAuto() {
      if (autoRefreshId) clearInterval(autoRefreshId);
      autoRefreshId = null;
      autoStateLabel.innerText = 'Off';
    }
    
    autoCheckbox.addEventListener('change', (e) => {
      if (e.target.checked) startAuto();
      else stopAuto();
    });

    // Create Alert
    document.getElementById('createAlertBtn').addEventListener('click', async () => {
      const title = document.getElementById('alertTitle').value.trim();
      const description = document.getElementById('alertDescription').value.trim();
      const severity = document.getElementById('alertSeverity').value;
      const statusElement = document.getElementById('createAlertStatus');
      
      if (!title || !description) {
        statusElement.textContent = 'Title and description are required';
        statusElement.className = 'text-xs text-red-400 mt-2';
        return;
      }
      
      statusElement.textContent = 'Creating alert...';
      statusElement.className = 'text-xs text-yellow-400 mt-2';
      
      try {
        const result = await createAlert(title, description, severity);
        statusElement.textContent = 'Alert created successfully!';
        statusElement.className = 'text-xs text-green-400 mt-2';
        
        // Clear form
        document.getElementById('alertTitle').value = '';
        document.getElementById('alertDescription').value = '';
        document.getElementById('alertSeverity').value = 'medium';
        
        // Refresh data
        setTimeout(refreshAll, 1000);
        
      } catch (error) {
        statusElement.textContent = 'Failed to create alert: ' + error.message;
        statusElement.className = 'text-xs text-red-400 mt-2';
      }
    });

    // Show raw toggle
    document.getElementById('showRaw').addEventListener('click', () => {
      const pre = document.getElementById('rawJson');
      pre.classList.toggle('hidden');
    });

    /* ---------- TIDE DATA ---------- */
const STORMGLASS_API_KEY = "739ac75a-85a8-11f0-a246-0242ac130006-739ac8b8-85a8-11f0-a246-0242ac130006";  // <-- replace with your key
const LAT = 22.3;   // Example: Khambhat latitude
const LNG = 72.6;   // Example: Khambhat longitude

async function fetchTides() {
  try {
    const response = await fetch(
      https://api.stormglass.io/v2/tide/sea-level/point?lat=${LAT}&lng=${LNG}&start=${new Date().toISOString()}&end=${new Date(Date.now()+24*3600*1000).toISOString()},
      {
        headers: { "Authorization": STORMGLASS_API_KEY }
      }
    );

    if (!response.ok) throw new Error("Failed to fetch tide data");
    const data = await response.json();
    renderTideInfo(data.data);
  } catch (err) {
    console.error("Tide fetch error:", err);
  }
}

function renderTideInfo(tides) {
  if (!tides || tides.length === 0) return;

  // Find next high & low tides
  let nextHigh = null, nextLow = null;
  for (let t of tides) {
    if (t.sg > 0 && !nextHigh) nextHigh = t;
    if (t.sg < 0 && !nextLow) nextLow = t;
    if (nextHigh && nextLow) break;
  }

  document.getElementById("nextHigh").innerText = nextHigh ? 
    ${new Date(nextHigh.time).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}, ${nextHigh.sg.toFixed(2)} m : "—";

  document.getElementById("nextLow").innerText = nextLow ? 
    ${new Date(nextLow.time).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}, ${nextLow.sg.toFixed(2)} m : "—";

  // Chart
  const ctx = document.getElementById("tideChart").getContext("2d");
  const labels = tides.map(t => new Date(t.time).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'}));
  const values = tides.map(t => t.sg);

  new Chart(ctx, {
    type: "line",
    data: {
      labels: labels,
      datasets: [{
        label: "Tide Height (m)",
        data: values,
        borderColor: "#38bdf8",
        backgroundColor: "rgba(56,189,248,0.3)",
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      scales: {
        x: { ticks: { color: "#94a3b8" } },
        y: { ticks: { color: "#94a3b8" } }
      },
      plugins: { legend: { labels: { color: "#e2e8f0" } } }
    }
  });
}

// Call on load
fetchTides();

    // Settings button
    document.getElementById('settingsBtn').addEventListener('click', () => {
      const newInterval = prompt('Enter refresh interval in seconds (current: ' + (autoRefreshInterval / 1000) + '):', autoRefreshInterval / 1000);
      if (newInterval && !isNaN(newInterval) && newInterval > 0) {
        autoRefreshInterval = newInterval * 1000;
        document.getElementById('intervalLabel').innerText = newInterval;
        if (autoRefreshId) {
          startAuto(); // Restart with new interval
        }
      }
    });

    // Initial load
    refreshAll();
    startAuto();
  </script>
</body>
</html>